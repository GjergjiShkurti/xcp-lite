name: XCP_lite Default

on:
  workflow_dispatch:
  push:
    branches: ["**"]
    tags: ["**"]

concurrency:
  group: ${{ (github.ref == 'refs/heads/main') && 'main' || format('{0}-{1}', github.workflow, github.ref) }} # concurrency does not include main branch
  cancel-in-progress: true

jobs:
    format:
      name: Format
      runs-on: [ubuntu-22.04]
      steps:
      - uses: actions/checkout@v3
      - uses: moonrepo/setup-rust@v1
        with:
              components: rustfmt
      - name: Check formatting
        run: cargo fmt --all --check
    lint:
        name: Lint
        runs-on: [ubuntu-22.04]
        steps:
        - uses: actions/checkout@v3
        - uses: moonrepo/setup-rust@v1
          with:
            bins: cargo-make
            components: clippy
        - name: Run linter
          run: cargo clippy
    build:
      name: Build
      runs-on: ${{ matrix.os }}
      strategy:
        matrix:
          os: [ubuntu-22.04, macos-latest]
        fail-fast: false
      steps:
        - uses: actions/checkout@v3
        - uses: moonrepo/setup-rust@v1
          with:
            components: rustfmt
        - name: Build binary
          run: |
            if [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
              sudo apt update
              sudo apt install build-essential
            fi
            cargo build --verbose
    test:
        name: Test
        runs-on: [ubuntu-22.04]
        strategy:
          matrix:
            os:
            - ubuntu
            # - macos-latest
            # - windows-latest
          fail-fast: false
        steps:
        - uses: actions/checkout@v3
        - uses: moonrepo/setup-rust@v1
          with:
            bins: cargo-make, cargo-nextest
        - name: Run tests
          run: cargo test --verbose -- --test-threads=1
    